{% extends "base.html" %}

{% block title %}لوحة التحكم - {{ store_settings.store_name or 'نظام إدارة المخزون' }}{% endblock %}

{% block content %}
<!-- ========================================
     لوحة التحكم الرئيسية
     تعرض الإحصائيات والبيانات المهمة
     ======================================== -->
<div class="container-fluid">
    <!-- ========================================
         رأس الصفحة
         ======================================== -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0 text-gray-800">
                    <i class="bi bi-speedometer2 me-2"></i>لوحة التحكم - {{ store_settings.store_name or 'مخزن الزينة' }}
                </h1>
                <div class="text-muted">
                    <i class="bi bi-calendar3 me-1"></i>
                    <span id="current-date"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Welcome Message for Cashier -->
    {% if session.get('role') == 'clerk' %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-person-check me-2"></i>
                <strong>مرحباً {{ session.get('username') }}!</strong> 
                مرحباً بك في نظام المبيعات. يمكنك استخدام نقطة البيع لإتمام المبيعات وعرض الفواتير.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <!-- إجمالي المبيعات اليوم -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-currency-dollar me-2"></i>مبيعات اليوم
                    </h6>
                </div>
                <div class="card-body">
                    <div class="h4 mb-0 text-primary font-weight-bold" id="today-sales">
                        {{ "%.2f"|format(today_sales|default(0)) }} ج.س
                    </div>
                </div>
            </div>
        </div>

        <!-- إجمالي المنتجات -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-box me-2"></i>إجمالي المنتجات
                    </h6>
                </div>
                <div class="card-body">
                    <div class="h4 mb-0 text-success font-weight-bold" id="total-items">
                        {{ total_items or 0 }}
                    </div>
                </div>
            </div>
        </div>

        <!-- المنتجات منخفضة المخزون -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-warning text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>منخفضة المخزون
                    </h6>
                </div>
                <div class="card-body">
                    <div class="h4 mb-0 text-warning font-weight-bold" id="low-stock">
                        {{ low_stock or 0 }}
                    </div>
                </div>
            </div>
        </div>

        <!-- إجمالي الفواتير -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-receipt me-2"></i>فواتير اليوم
                    </h6>
                </div>
                <div class="card-body">
                    <div class="h4 mb-0 text-info font-weight-bold" id="today-invoices">
                        {{ today_invoices or 0 }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-lightning me-2"></i>الإجراءات السريعة
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <a href="{{ url_for('sales.new') }}" class="btn btn-primary btn-lg w-100 d-flex align-items-center justify-content-center">
                                <i class="bi bi-cart-plus me-2"></i>
                                <span>نقطة البيع</span>
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{{ url_for('invoices.list') }}" class="btn btn-info btn-lg w-100 d-flex align-items-center justify-content-center">
                                <i class="bi bi-list-ul me-2"></i>
                                <span>قائمة الفواتير</span>
                            </a>
                        </div>
                        <!-- Hidden: New Invoice button removed from dashboard -->
                        <!-- <div class="col-md-3 mb-3">
                            <a href="{{ url_for('invoices.new') }}" class="btn btn-warning btn-lg w-100 d-flex align-items-center justify-content-center">
                                <i class="bi bi-receipt me-2"></i>
                                <span>فاتورة جديدة</span>
                            </a>
                        </div> -->
                        {% if session.get('role') == 'manager' %}
                        <div class="col-md-3 mb-3">
                            <a href="{{ url_for('items.new') }}" class="btn btn-success btn-lg w-100 d-flex align-items-center justify-content-center">
                                <i class="bi bi-plus-circle me-2"></i>
                                <span>إضافة منتج</span>
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{{ url_for('reports.index') }}" class="btn btn-warning btn-lg w-100 d-flex align-items-center justify-content-center">
                                <i class="bi bi-graph-up me-2"></i>
                                <span>التقارير</span>
                            </a>
                        </div>
                        {% else %}
                        <div class="col-md-6 mb-3">
                            <div class="alert alert-info text-center h-100 d-flex align-items-center justify-content-center">
                                <div>
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>مرحباً بك في نظام المبيعات</strong>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="row">
        <!-- المبيعات الأخيرة -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header bg-primary text-white d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold">
                        <i class="bi bi-clock-history me-2"></i>المبيعات الأخيرة
                    </h6>
                    <a href="{{ url_for('sales.list') }}" class="btn btn-sm btn-light">عرض الكل</a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>المنتج</th>
                                    <th>الكمية</th>
                                    <th>المبلغ</th>
                                    <th>الوقت</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sale in recent_sales %}
                                <tr>
                                    <td>{{ sale.name }}</td>
                                    <td>{{ sale.quantity }}</td>
                                    <td>{{ "%.2f"|format(sale.total_price) }} ج.س</td>
                                    <td>{{ sale.created_at.split(' ')[1][:5] if ' ' in sale.created_at else sale.created_at }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted">
                                        <i class="bi bi-inbox me-2"></i>لا توجد مبيعات
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- أكثر المنتجات مبيعاً -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header bg-success text-white d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold">
                        <i class="bi bi-trophy me-2"></i>أكثر المنتجات مبيعاً
                    </h6>
                    <span class="badge bg-light text-success">آخر 7 أيام</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>المنتج</th>
                                    <th>الكمية الحالية</th>
                                    <th>حد إعادة الطلب</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in low_stock_items %}
                                <tr>
                                    <td>{{ item.name }}</td>
                                    <td><span class="badge bg-warning">{{ item.quantity }}</span></td>
                                    <td>{{ item.reorder_level }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">
                                        <i class="bi bi-inbox me-2"></i>لا توجد بيانات
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- الفواتير الأخيرة -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card shadow">
                <div class="card-header bg-info text-white d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold">
                        <i class="bi bi-receipt me-2"></i>الفواتير الأخيرة
                    </h6>
                    <a href="{{ url_for('invoices.list') }}" class="btn btn-sm btn-light">عرض الكل</a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>رقم الفاتورة</th>
                                    <th>العميل</th>
                                    <th>المبلغ الإجمالي</th>
                                    <th>تاريخ الإنشاء</th>
                                    <th>أنشأ بواسطة</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for invoice in recent_invoices %}
                                <tr>
                                    <td><a href="{{ url_for('invoices.view', invoice_id=invoice.id) }}" class="text-decoration-none">#{{ invoice.id }}</a></td>
                                    <td>{{ invoice.customer_name or 'عميل نقدي' }}</td>
                                    <td>{{ "%.2f"|format(invoice.total_amount) }} ج.س</td>
                                    <td>{{ invoice.created_at.split(' ')[0] + ' ' + invoice.created_at.split(' ')[1][:5] if ' ' in invoice.created_at else invoice.created_at }}</td>
                                    <td>{{ invoice.created_by or 'نظام' }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted">
                                        <i class="bi bi-inbox me-2"></i>لا توجد فواتير
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    </div>

    <!-- العمليات الإضافية -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-gear me-2"></i>العمليات الإضافية
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <button class="btn btn-info btn-lg w-100 d-flex align-items-center justify-content-center" onclick="refreshDashboard()">
                                <i class="bi bi-arrow-clockwise me-2"></i>
                                <span>تحديث البيانات</span>
                            </button>
                        </div>
                        {% if session.get('username') == 'dev' %}
                        <div class="col-md-3 mb-3">
                            <button class="btn btn-warning btn-lg w-100 d-flex align-items-center justify-content-center" onclick="exportTodayData()">
                                <i class="bi bi-download me-2"></i>
                                <span>تصدير اليوم</span>
                            </button>
                        </div>
                        {% endif %}
                        <div class="col-md-3 mb-3">
                            <button class="btn btn-success btn-lg w-100 d-flex align-items-center justify-content-center" onclick="backupData()">
                                <i class="bi bi-shield-check me-2"></i>
                                <span>نسخ احتياطي</span>
                            </button>
                        </div>
                        <div class="col-md-3 mb-3">
                            <button class="btn btn-secondary btn-lg w-100 d-flex align-items-center justify-content-center" onclick="clearCache()">
                                <i class="bi bi-trash me-2"></i>
                                <span>مسح الذاكرة</span>
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <button class="btn btn-primary btn-lg w-100 d-flex align-items-center justify-content-center" onclick="showSystemInfo()">
                                <i class="bi bi-info-circle me-2"></i>
                                <span>معلومات النظام</span>
                            </button>
                        </div>
                        <div class="col-md-3 mb-3">
                            <button class="btn btn-outline-primary btn-lg w-100 d-flex align-items-center justify-content-center" onclick="showHelp()">
                                <i class="bi bi-question-circle me-2"></i>
                                <span>المساعدة</span>
                            </button>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="alert alert-info text-center mb-0 h-100 d-flex align-items-center justify-content-center">
                                <div>
                                    <i class="bi bi-lightbulb me-2"></i>
                                    <strong>نصيحة:</strong> استخدم هذه الأدوات لإدارة النظام وتحسين الأداء
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="sr-only">جاري التحميل...</span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // تحديث التاريخ
    updateCurrentDate();
    
    // تحميل البيانات
    loadDashboardData();
    
    // تحديث البيانات كل 30 ثانية
    setInterval(loadDashboardData, 30000);
});

function updateCurrentDate() {
    const now = new Date();
    const options = { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        weekday: 'long'
    };
    document.getElementById('current-date').textContent = now.toLocaleDateString('ar-SA', options);
}

function loadDashboardData() {
    // تحميل المبيعات الأخيرة
    fetch('/api/recent-sales')
        .then(response => response.json())
        .then(data => {
            updateRecentSales(data);
        })
        .catch(error => {
            console.error('خطأ في تحميل المبيعات:', error);
        });
    
    // تحميل المنتجات منخفضة المخزون
    fetch('/api/low-stock')
        .then(response => response.json())
        .then(data => {
            updateLowStockItems(data);
        })
        .catch(error => {
            console.error('خطأ في تحميل المخزون:', error);
        });
}

function updateRecentSales(sales) {
    const tbody = document.getElementById('recent-sales');
    
    if (sales.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">لا توجد مبيعات</td></tr>';
        return;
    }
    
    tbody.innerHTML = sales.map(sale => `
        <tr>
            <td>${formatTime(sale.created_at)}</td>
            <td>${sale.total_amount} ج.س</td>
            <td>${sale.customer_name || 'غير محدد'}</td>
        </tr>
    `).join('');
}

function updateLowStockItems(items) {
    const tbody = document.getElementById('low-stock-items');
    
    if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">جميع المنتجات متوفرة</td></tr>';
        return;
    }
    
    tbody.innerHTML = items.map(item => `
        <tr>
            <td>${item.name}</td>
            <td><span class="badge badge-warning">${item.quantity}</span></td>
            <td>${item.min_quantity}</td>
        </tr>
    `).join('');
}

function formatTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleTimeString('ar-SA', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
}

// إظهار/إخفاء شاشة التحميل
function showLoading() {
    document.getElementById('loading-overlay').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loading-overlay').style.display = 'none';
}
</script>
{% endblock %}