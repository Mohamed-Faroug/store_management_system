{% extends "mobile/base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- الجانب الأيسر - المنتجات -->
        <div class="col-lg-8">
            <div class="mobile-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4><i class="bi bi-cart-plus me-2"></i>نقطة البيع</h4>
                    <button class="mobile-btn mobile-btn-secondary" onclick="goBack()">
                        <i class="bi bi-arrow-right me-2"></i>العودة
                    </button>
                </div>
                
                <!-- البحث -->
                <div class="mobile-search">
                    <input type="text" class="mobile-search-input" id="searchInput" 
                           placeholder="البحث عن المنتج...">
                    <i class="bi bi-search mobile-search-icon"></i>
                </div>
                
                <!-- قائمة المنتجات -->
                <div id="itemsList" class="mobile-grid">
                    <!-- سيتم تحميل المنتجات هنا -->
                </div>
            </div>
        </div>
        
        <!-- الجانب الأيمن - سلة التسوق -->
        <div class="col-lg-4">
            <div class="mobile-card">
                <h5><i class="bi bi-cart me-2"></i>سلة التسوق</h5>
                
                <!-- سلة التسوق -->
                <div id="cartItems" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-cart-x" style="font-size: 48px; opacity: 0.3;"></i>
                        <p>السلة فارغة</p>
                    </div>
                </div>
                
                <!-- إجمالي السلة -->
                <div class="mobile-cart-total" id="cartTotal">
                    الإجمالي: 0.00 ج.س
                </div>
                
                <!-- أزرار التحكم -->
                <div class="d-grid gap-2 mt-3">
                    <button class="mobile-btn mobile-btn-danger" onclick="clearCart()">
                        <i class="bi bi-trash me-2"></i>مسح السلة
                    </button>
                    <button class="mobile-btn mobile-btn-success" onclick="checkout()">
                        <i class="bi bi-check-circle me-2"></i>إتمام البيع
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let cart = [];
let allItems = [];

// تحميل المنتجات
async function loadItems() {
    try {
        const response = await apiCall('/api/items');
        allItems = response.items;
        displayItems(allItems);
    } catch (error) {
        console.error('Error loading items:', error);
        showAlert('خطأ في تحميل المنتجات', 'danger');
    }
}

// عرض المنتجات
function displayItems(items) {
    const itemsList = document.getElementById('itemsList');
    itemsList.innerHTML = '';
    
    if (items.length === 0) {
        itemsList.innerHTML = `
            <div class="col-12 text-center text-muted py-4">
                <i class="bi bi-search" style="font-size: 48px; opacity: 0.3;"></i>
                <p>لا توجد منتجات</p>
            </div>
        `;
        return;
    }
    
    items.forEach(item => {
        const itemCard = document.createElement('div');
        itemCard.className = 'mobile-item-card';
        itemCard.innerHTML = `
            <div class="mobile-item-name">${item.name}</div>
            <div class="mobile-item-price">${item.price.toFixed(2)} ج.س</div>
            <div class="mobile-item-stock">المخزون: ${item.quantity}</div>
            <button class="mobile-btn mobile-btn-success w-100 mt-2" 
                    onclick="addToCart(${item.id})" 
                    ${item.quantity <= 0 ? 'disabled' : ''}>
                <i class="bi bi-plus-circle me-2"></i>إضافة للسلة
            </button>
        `;
        itemsList.appendChild(itemCard);
    });
}

// البحث عن المنتجات
async function searchItems(query) {
    if (!query.trim()) {
        displayItems(allItems);
        return;
    }
    
    try {
        const response = await apiCall(`/api/search_items?q=${encodeURIComponent(query)}`);
        displayItems(response.items);
    } catch (error) {
        console.error('Error searching items:', error);
    }
}

// إضافة منتج للسلة
function addToCart(itemId) {
    const item = allItems.find(i => i.id === itemId);
    if (!item || item.quantity <= 0) {
        showAlert('المنتج غير متوفر في المخزون', 'warning');
        return;
    }
    
    const existingItem = cart.find(i => i.id === itemId);
    if (existingItem) {
        existingItem.quantity += 1;
    } else {
        cart.push({
            id: item.id,
            name: item.name,
            price: item.price,
            quantity: 1
        });
    }
    
    updateCartDisplay();
    showAlert(`تم إضافة ${item.name} للسلة`, 'success');
}

// تحديث عرض السلة
function updateCartDisplay() {
    const cartItems = document.getElementById('cartItems');
    const cartTotal = document.getElementById('cartTotal');
    
    if (cart.length === 0) {
        cartItems.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="bi bi-cart-x" style="font-size: 48px; opacity: 0.3;"></i>
                <p>السلة فارغة</p>
            </div>
        `;
        cartTotal.textContent = 'الإجمالي: 0.00 ج.س';
        return;
    }
    
    let total = 0;
    cartItems.innerHTML = '';
    
    cart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        total += itemTotal;
        
        const cartItem = document.createElement('div');
        cartItem.className = 'mobile-cart-item';
        cartItem.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="mobile-cart-item-name">${item.name}</div>
                    <div class="mobile-cart-item-details">
                        ${item.price.toFixed(2)} ج.س × ${item.quantity} = ${itemTotal.toFixed(2)} ج.س
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <button class="btn btn-sm btn-outline-danger me-2" onclick="removeFromCart(${item.id})">
                        <i class="bi bi-dash"></i>
                    </button>
                    <span class="me-2">${item.quantity}</span>
                    <button class="btn btn-sm btn-outline-success" onclick="addQuantity(${item.id})">
                        <i class="bi bi-plus"></i>
                    </button>
                </div>
            </div>
        `;
        cartItems.appendChild(cartItem);
    });
    
    cartTotal.textContent = `الإجمالي: ${total.toFixed(2)} ج.س`;
}

// إزالة منتج من السلة
function removeFromCart(itemId) {
    const itemIndex = cart.findIndex(i => i.id === itemId);
    if (itemIndex !== -1) {
        if (cart[itemIndex].quantity > 1) {
            cart[itemIndex].quantity -= 1;
        } else {
            cart.splice(itemIndex, 1);
        }
        updateCartDisplay();
    }
}

// زيادة كمية منتج في السلة
function addQuantity(itemId) {
    const item = cart.find(i => i.id === itemId);
    if (item) {
        item.quantity += 1;
        updateCartDisplay();
    }
}

// مسح السلة
function clearCart() {
    if (cart.length === 0) {
        showAlert('السلة فارغة بالفعل', 'info');
        return;
    }
    
    if (confirm('هل أنت متأكد من مسح السلة؟')) {
        cart = [];
        updateCartDisplay();
        showAlert('تم مسح السلة', 'success');
    }
}

// إتمام البيع
async function checkout() {
    if (cart.length === 0) {
        showAlert('السلة فارغة', 'warning');
        return;
    }
    
    if (!confirm('هل أنت متأكد من إتمام البيع؟')) {
        return;
    }
    
    try {
        const response = await apiCall('/api/checkout', {
            method: 'POST',
            body: JSON.stringify({ cart })
        });
        
        if (response.success) {
            showAlert(response.message, 'success');
            cart = [];
            updateCartDisplay();
            loadItems(); // إعادة تحميل المنتجات لتحديث المخزون
        } else {
            showAlert(response.message, 'danger');
        }
    } catch (error) {
        console.error('Checkout error:', error);
    }
}

// العودة للوحة التحكم
function goBack() {
    window.location.href = '/';
}

// البحث
document.getElementById('searchInput').addEventListener('input', function() {
    const query = this.value;
    searchItems(query);
});

// تحميل المنتجات عند بدء الصفحة
document.addEventListener('DOMContentLoaded', function() {
    loadItems();
});
</script>
{% endblock %}
