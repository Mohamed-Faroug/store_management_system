#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† - Ù…Ù„Ù Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
ØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨ÙˆØ§Ø³Ø·Ø©: Ù…Ø­Ù…Ø¯ ÙØ§Ø±ÙˆÙ‚
ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: 9/9/2025
Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2025
"""

import os
import sys
import webbrowser
import threading
import time
from pathlib import Path

# Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
current_dir = Path(__file__).parent.absolute()
sys.path.insert(0, str(current_dir))

def check_dependencies():
    """ÙØ­Øµ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©"""
    try:
        import flask
        import werkzeug
        import sqlite3
        print("âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ù…ØªÙˆÙØ±Ø©")
        return True
    except ImportError as e:
        print(f"âŒ Ù…ÙƒØªØ¨Ø© Ù…ÙÙ‚ÙˆØ¯Ø©: {e}")
        return False

def setup_environment():
    """Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©"""
    try:
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯Ø§Øª Ø¶Ø±ÙˆØ±ÙŠØ©
        os.makedirs('logs', exist_ok=True)
        os.makedirs('backups', exist_ok=True)
        os.makedirs('temp', exist_ok=True)
        
        # ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
        os.environ['FLASK_ENV'] = 'production'
        os.environ['FLASK_DEBUG'] = 'False'
        
        print("âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø© Ø¨Ù†Ø¬Ø§Ø­")
        return True
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©: {e}")
        return False

def start_server():
    """ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…"""
    try:
        from app import create_app
        
        app = create_app()
        
        # Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³Ø§Ø± Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ù„Ù„Ù€ EXE
        import sys
        if getattr(sys, 'frozen', False):
            # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„ ÙƒÙ€ EXE
            template_dir = os.path.join(os.path.dirname(sys.executable), 'app', 'templates')
            static_dir = os.path.join(os.path.dirname(sys.executable), 'app', 'static')
            
            if os.path.exists(template_dir):
                app.template_folder = template_dir
            if os.path.exists(static_dir):
                app.static_folder = static_dir
        
        # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…
        print("ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†...")
        print("ğŸ“± Ø³ÙŠØªÙ… ÙØªØ­ Ø§Ù„Ù…ØªØµÙØ­ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹...")
        
        # ÙØªØ­ Ø§Ù„Ù…ØªØµÙØ­ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
        def open_browser():
            time.sleep(2)
            webbrowser.open('http://127.0.0.1:8080')
        
        browser_thread = threading.Thread(target=open_browser)
        browser_thread.daemon = True
        browser_thread.start()
        
        # ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        app.run(
            host='127.0.0.1',
            port=8080,
            debug=False,
            use_reloader=False,
            threaded=True
        )
        
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…: {e}")
        import traceback
        traceback.print_exc()
        input("Ø§Ø¶ØºØ· Enter Ù„Ù„Ø®Ø±ÙˆØ¬...")

def main():
    """Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
    print("=" * 50)
    print("ğŸª Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† - Ù…Ø®Ø²Ù† Ø§Ù„Ø²ÙŠÙ†Ø©")
    print("ğŸ‘¨â€ğŸ’» ØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨ÙˆØ§Ø³Ø·Ø©: Ù…Ø­Ù…Ø¯ ÙØ§Ø±ÙˆÙ‚")
    print("ğŸ“… ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: 9/9/2025")
    print("Â© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© 2025")
    print("=" * 50)
    
    # ÙØ­Øµ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
    if not check_dependencies():
        print("\nâŒ ÙŠØ±Ø¬Ù‰ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø£ÙˆÙ„Ø§Ù‹:")
        print("pip install -r requirements.txt")
        input("Ø§Ø¶ØºØ· Enter Ù„Ù„Ø®Ø±ÙˆØ¬...")
        return
    
    # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©
    if not setup_environment():
        input("Ø§Ø¶ØºØ· Enter Ù„Ù„Ø®Ø±ÙˆØ¬...")
        return
    
    # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…
    try:
        start_server()
    except KeyboardInterrupt:
        print("\nğŸ‘‹ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
    except Exception as e:
        print(f"\nâŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: {e}")
        input("Ø§Ø¶ØºØ· Enter Ù„Ù„Ø®Ø±ÙˆØ¬...")

if __name__ == "__main__":
    main()
