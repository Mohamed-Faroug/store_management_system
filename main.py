# -*- coding: utf-8 -*-
"""
Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† - Ù…Ø®Ø²Ù† Ø§Ù„Ø²ÙŠÙ†Ø©
Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ

Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2025
ØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨ÙˆØ§Ø³Ø·Ø©: Ù…Ø­Ù…Ø¯ ÙØ§Ø±ÙˆÙ‚
ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: 9/9/2025
"""

import os
import sys
from app import create_app
from app.models.database import init_db
from config import config

def get_config():
    """Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¨ÙŠØ¦Ø©"""
    env = os.environ.get('FLASK_ENV', 'development')
    return config.get(env, config['default'])

app = create_app()

@app.teardown_appcontext
def close_db(exception=None):
    """Ø¥ØºÙ„Ø§Ù‚ Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
    from app.models.database import close_db
    close_db(exception)

def create_directories():
    """Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©"""
    directories = ['logs', 'backups', 'temp', 'uploads', 'data']
    for directory in directories:
        os.makedirs(directory, exist_ok=True)

if __name__ == '__main__':
    # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    create_directories()
    
    # ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    with app.app_context():
        init_db()
    
    # ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    config_obj = get_config()
    
    if config_obj.DEBUG:
        print("ğŸš€ ØªØ´ØºÙŠÙ„ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ·ÙˆÙŠØ±")
        app.run(debug=True, host='127.0.0.1', port=8080, use_reloader=False)
    else:
        print("ğŸš€ ØªØ´ØºÙŠÙ„ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ù†ØªØ§Ø¬")
        from waitress import serve
        serve(app, host='0.0.0.0', port=8080)
