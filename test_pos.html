<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار نظام POS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2>اختبار نظام POS</h2>
        <div class="row">
            <div class="col-md-6">
                <h4>السلة</h4>
                <div id="cart-items">
                    <div class="text-center text-muted py-4" id="empty-cart">
                        <i class="bi bi-cart-x display-4 d-block mb-2"></i>
                        <p>السلة فارغة</p>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="addTestItem()">إضافة عنصر تجريبي</button>
                    <button class="btn btn-success" onclick="addSameItem()">إضافة نفس العنصر</button>
                    <button class="btn btn-info" onclick="addMultipleItems()">إضافة 9 عناصر</button>
                    <button class="btn btn-danger" onclick="clearCart()">مسح السلة</button>
                </div>
            </div>
            <div class="col-md-6">
                <h4>معلومات التصحيح</h4>
                <div id="debug-info" class="bg-light p-3 rounded">
                    <pre id="debug-output"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        let cart = [];
        let itemCounter = 1;

        function addTestItem() {
            const itemId = itemCounter++;
            const itemName = `عنصر تجريبي ${itemId}`;
            const price = Math.random() * 100 + 10;
            const stock = Math.floor(Math.random() * 20) + 1;
            
            console.log('Adding test item:', {itemId, itemName, price, stock});
            addToCart(itemId, itemName, price, stock);
            updateDebugInfo();
        }
        
        function addMultipleItems() {
            // Add 9 different items to test the 3x3 layout
            for (let i = 1; i <= 9; i++) {
                const itemId = i;
                const itemName = `عنصر ${i}`;
                const price = 10 + (i * 5);
                const stock = 10 + i;
                
                addToCart(itemId, itemName, price, stock);
            }
            updateDebugInfo();
        }
        
        function addSameItem() {
            // Add the same item multiple times to test quantity update
            const itemId = 1;
            const itemName = 'عنصر ثابت';
            const price = 50.00;
            const stock = 10;
            
            console.log('Adding same item multiple times');
            addToCart(itemId, itemName, price, stock);
            updateDebugInfo();
        }

        function addToCart(itemId, itemName, price, stock) {
            console.log('Adding item to cart:', {itemId, itemName, price, stock});
            
            if (stock <= 0) {
                alert('هذا الصنف غير متوفر في المخزون');
                return;
            }
            
            // Convert itemId to number for comparison
            const numericItemId = parseInt(itemId);
            const existingItem = cart.find(item => parseInt(item.id) === numericItemId);
            
            if (existingItem) {
                console.log('Item exists, current quantity:', existingItem.quantity);
                if (existingItem.quantity >= stock) {
                    alert(`الكمية المتاحة: ${stock} فقط`);
                    return;
                }
                existingItem.quantity += 1;
                console.log('Updated quantity to:', existingItem.quantity);
            } else {
                const newItem = {
                    id: numericItemId,
                    name: itemName,
                    price: parseFloat(price),
                    quantity: 1,
                    stock: parseInt(stock)
                };
                cart.push(newItem);
                console.log('Added new item:', newItem);
            }
            
            console.log('Cart after update:', cart);
            console.log('Cart length after update:', cart.length);
            
            updateCartDisplay();
            updateDebugInfo();
        }

        function updateCartDisplay() {
            console.log('Updating cart display, cart length:', cart.length);
            const cartItems = document.getElementById('cart-items');
            
            // Clear the cart items container completely
            cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<div class="text-center text-muted py-4" id="empty-cart"><i class="bi bi-cart-x display-4 d-block mb-2"></i><p>السلة فارغة</p></div>';
                console.log('Cart is empty, showing empty message');
                return;
            }
            
            let cartHTML = '';
            cart.forEach((item, index) => {
                console.log(`Rendering item ${index}:`, item);
                const itemTotal = parseFloat(item.price) * parseInt(item.quantity);
                cartHTML += `
                    <div class="cart-item border-bottom py-2" data-item-id="${item.id}">
                        <div class="row align-items-center">
                            <div class="col-6">
                                <h6 class="mb-1">${item.name}</h6>
                                <small class="text-muted">${parseFloat(item.price).toFixed(2)} ج.س</small>
                            </div>
                            <div class="col-3">
                                <div class="input-group input-group-sm">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="updateQuantity(${item.id}, ${parseInt(item.quantity) - 1})">-</button>
                                    <input type="number" class="form-control text-center" value="${parseInt(item.quantity)}" min="1" max="${parseInt(item.stock)}" onchange="updateQuantity(${item.id}, parseInt(this.value))">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="updateQuantity(${item.id}, ${parseInt(item.quantity) + 1})">+</button>
                                </div>
                            </div>
                            <div class="col-2 text-end">
                                <strong>${itemTotal.toFixed(2)} ج.س</strong>
                            </div>
                            <div class="col-1">
                                <button class="btn btn-outline-danger btn-sm" onclick="removeFromCart(${item.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            cartItems.innerHTML = cartHTML;
            console.log('Cart HTML updated with', cart.length, 'items');
        }

        function updateQuantity(itemId, newQuantity) {
            if (newQuantity <= 0) {
                removeFromCart(itemId);
                return;
            }
            
            const item = cart.find(item => item.id === itemId);
            if (item) {
                if (newQuantity > item.stock) {
                    alert(`الكمية المتاحة: ${item.stock} فقط`);
                    newQuantity = item.stock;
                }
                item.quantity = newQuantity;
                updateCartDisplay();
                updateDebugInfo();
            }
        }

        function removeFromCart(itemId) {
            cart = cart.filter(item => item.id !== itemId);
            updateCartDisplay();
            updateDebugInfo();
        }

        function clearCart() {
            if (confirm('هل أنت متأكد من مسح السلة؟')) {
                cart = [];
                updateCartDisplay();
                updateDebugInfo();
            }
        }

        function updateDebugInfo() {
            const debugOutput = document.getElementById('debug-output');
            debugOutput.textContent = JSON.stringify(cart, null, 2);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Test POS System initialized');
            cart = [];
            updateDebugInfo();
        });
    </script>
</body>
</html>
